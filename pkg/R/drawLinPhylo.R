drawLinPhylo <- function (pP, uSR = NULL, addTimeLine = "none", tmScl, whatTime = c("epoch",     "age"), l2r = FALSE, nmLim = 2, cexText = 0.5,     cexTime = 0.5, cexLab = 0.5, lwdLin = 2, hlty = NULL, barLen=0) {    if (class(pP) != "paleoPhylo")         stop(" object is not of class 'paleoPhylo'")    {        if (addTimeLine == "classic" | addTimeLine == "c" | addTimeLine == "tube" | addTimeLine == "t") {            tmScl <- tmScl[tmScl$MA <= max(pP$st), ]            startPoint <- which(tmScl$MA == tmScl$MA[(which(tmScl$MA >                 min(pP$en))[1])])            if (startPoint > 1) {              startPoint <- startPoint - 1           }            tmScl <- tmScl[startPoint:dim(tmScl)[1], ]            tmScl$prntName <- c(1, abs(diff(tmScl$MA)) > 2 - 1)        }        if (addTimeLine == "classic" | addTimeLine == "c") {            sz <- exp(-(length(pP$nm) + 35)/50) + 0.1            ifelse(l2r == FALSE, fig.mat <- matrix(c(0, sz, sz, 1, 0, 0, 1, 1), nrow = 2), fig.mat <- matrix(c(0, 0, 1, 1, 0, sz, sz, 1), nrow = 2))            split.screen(fig.mat)            screen(1)            par(mar = c(0.1, 0.1, 0.1, 0.1), srt = 90)            if (l2r == FALSE) {                plot(seq(0, 1, length.out = length(pP$st)), -pP$st, type = "n", axes = FALSE, xlab = "", ylab = "", ylim = range(-max(pP$st, tmScl$MA), -extendrange(c(pP$st, pP$en, tmScl$MA), f = 0.1)[1]))            }            if (l2r == TRUE) {                plot(-pP$st, seq(0, 1, length.out = length(pP$st)), type = "n", axes = FALSE, xlab = "", ylab = "", xlim = range(-max(pP$st, tmScl$MA), -extendrange(c(pP$st, pP$en, tmScl$MA), f = 0.1)[1]))            }            xx <- seq(0, 0.7, length.out = (length(whatTime) +                 1))            for (i in 1:length(whatTime)) {                ii <- which(colnames(tmScl) == whatTime[i])                st <- c(sort(tapply(tmScl$MA, as.character(tmScl[, ii]), max))[-length(unique(as.character(tmScl[, ii])))])                en <- sort(tapply(tmScl$MA, as.character(tmScl[,     ii]), max))[-1]                if (length(intersect(en, min(tmScl$MA))) == 0) {                  en <- c(sort(tapply(tmScl$MA, as.character(tmScl[,                     ii]), max))[1], en)                  st <- c(sort(tapply(tmScl$MA, as.character(tmScl[,                     ii]), min))[1], st)                }                if (l2r == FALSE) {                  allShort <- sum(nchar(as.character(tmScl[,   ii])) < 5) != length(tmScl[, ii])                  par(srt = 90 * allShort)                  rect(xx[i], -st, xx[i + 1], -en)                  text((xx[i] + xx[i + 1])/2, y = -c((st + en)/2),      names(en), col = (abs(st - en) > nmLim),     cex = cexText)                  segments(xx[i], -st, xx[i + 1], -st, lwd = 2)                }                if (l2r == TRUE) {                  allShort <- sum(nchar(as.character(tmScl[,  ii])) < 5) != length(tmScl[, ii])                  par(srt = 90 - 90 * allShort)                  rect(-st, xx[i], -en, xx[i + 1])                  text(-c((st + en)/2), y = (xx[i] + xx[i + 1])/2,                     names(en), col = (abs(st - en) > nmLim),                     cex = cexText)                  segments(-st, xx[i], -st, xx[i + 1], lwd = 2)                }            }            par(srt = 0)            if (l2r == FALSE) {                text(0.97, -tmScl$MA, tmScl$MA, adj = 1, cex = cexTime)            }            else {  text(-tmScl$MA, 0.97, tmScl$MA, adj = 0.5, cex = cexTime)    }                        thk <- (!duplicated(tmScl[, which(colnames(tmScl) == whatTime[1])])[-1]) + 1            screen(2, FALSE)            par(mar = c(0.1, 0.1, 0.1, 0.1))            if (l2r == FALSE) {                plot(seq(0, 1, length.out = length(pP$st)), -pP$st, type = "n", axes = FALSE, xlab = "", ylab = "", ylim = range(-max(pP$st, tmScl$MA), -extendrange(c(pP$st, pP$en, tmScl$MA), f = 0.1)[1]),xlim = extendrange(pP$xx, f = 0.1))            }            if (l2r == TRUE) {                plot(-pP$st, seq(0, 1, length.out = length(pP$st)), type = "n", axes = FALSE, xlab = "", ylab = "", xlim = range(-max(pP$st, tmScl$MA), -extendrange(c(pP$st, pP$en, tmScl$MA), f = 0.1)[1]),ylim = extendrange(pP$xx, f = 0.1))            }            if (l2r == FALSE) { abline(h = -tmScl$MA, col = "slategray4", lwd = thk)  }  else {   abline(v = -tmScl$MA, col = "slategray4", lwd = thk) }        }        if (addTimeLine == "tube" | addTimeLine == "t") {            if (length(whatTime) != 2)                 stop("if addTimeLine=='tube' then whatTime currently must have 2 levels.")            if (l2r == FALSE) {                par(mar = c(0, 2, 0, 0), srt = 0)            }            else {                par(mar = c(2, 0, 0, 0))            }            if (l2r == FALSE) {                plot(seq(0, 1, length.out = length(pP$st)), -pP$st, type = "n", axes = FALSE, xlab = "", ylab = "", ylim = range(-max(pP$st, tmScl$MA), -extendrange(c(pP$st, pP$en, tmScl$MA), f = 0.1)[1]),xlim = extendrange(pP$xx, f = 0.1))            }            if (l2r == TRUE) {                plot(-pP$st, seq(0, 1, length.out = length(pP$st)), type = "n", axes = FALSE, xlab = "", ylab = "", xlim = range(-max(pP$st, tmScl$MA), -extendrange(c(pP$st, pP$en, tmScl$MA), f = 0.1)[1]),ylim = extendrange(pP$xx, f = 0.1))            }            par(las=1)            mtext(round(tmScl$MA[tmScl$prntName == 1], 1), side = (l2r == FALSE) + 1, at = -(tmScl$MA[tmScl$prntName == 1]), col = 1, adj = 1, cex = cexTime, line = -3 + l2r)            par(las=0)            mtext("Age [ma]", side = (l2r == FALSE) + 1, cex = 1.5, padj = 1, outer = FALSE, line = 0-l2r)                splits <- paste(tmScl[, which(colnames(tmScl) ==  whatTime[1])], tmScl[, which(colnames(tmScl) ==  whatTime[2])])            boundaries <- c(min(pP$en), sort(tapply(tmScl$MA, splits, max)))            st <- boundaries[1:(length(boundaries) - 1)]            en <- boundaries[2:length(boundaries)]            if (l2r == FALSE) {                rect(0, -st, 1, -en, col = c("white", "gray75"), border = c("white", "gray75"))              	text(0.49, y = -(st + en)/2, sapply(1:length(en), function(i) strsplit(names(en)," ")[[i]][1]), col = c("gray75", "white"), cex = cexText, adj = c(1, 0.5))                text(0.51, y = -(st + en)/2, sapply(1:length(en), function(i) strsplit(names(en)," ")[[i]][2]), col = c("gray75", "white"), cex = cexText, adj = c(0, 0.5))                }            if (l2r == TRUE) {                par(srt = 270)                rect(-st, 0, -en, 1, col = c("white", "gray75"), border = c("white", "gray75"))                text(-(st + en)/2, y = 0.51, sapply(1:length(en), function(i) strsplit(names(en)," ")[[i]][1]), col = c("gray75", "white"), cex = cexText, adj = c(1, 0.5))                text(-(st + en)/2, y = 0.49, sapply(1:length(en), function(i) strsplit(names(en)," ")[[i]][2]), col = c("gray75", "white"), cex = cexText, adj = c(0, 0.5))            }        }        par(srt = 90)        uSR <- incStratUnc(uSR, pP, lwdLin = lwdLin)        if (addTimeLine == "simple" | addTimeLine == "none" |             addTimeLine == "s" | addTimeLine == "n") {            par(mar = c(0, 2, 0, 0))            if (l2r == FALSE) {                plot(pP$xx, -pP$st, type = "n", axes = FALSE,                   xlab = "", ylab = "", ylim = range(-max(pP$st),                     -extendrange(c(pP$st, pP$en), f = 0.1)[1]),                   xlim = extendrange(pP$xx, f = 0.1))            }            if (l2r == TRUE) {                plot(-pP$st, pP$xx, type = "n", axes = FALSE,                   xlab = "", ylab = "", xlim = range(-max(pP$st),                     -extendrange(c(pP$st, pP$en), f = 0.1)[1]),                   ylim = extendrange(pP$xx, f = 0.1))            }            if (addTimeLine == "simple" | addTimeLine == "s") {                arrows(extendrange(pP$xx, f = 0.1)[1], min(-pP$st),                   extendrange(pP$xx, f = 0.1)[1], -min(pP$en),                   lwd = lwdLin)                mtext("Time", side = 2, outer = FALSE, line = -0.5,                   cex = cexText)            }        }        tips <- 0 + (pP$en == min(pP$en)) * 15        for (n in 1:length(pP$nm)) {            mm <- sapply(uSR$types, length)            for (m in 1:mm[n]) {                lwdI <- as.numeric(uSR$styles[[uSR$types[[n]][m]]][1])                clrI <- uSR$styles[[uSR$types[[n]][m]]][2]                ltyI <- as.numeric(uSR$styles[[uSR$types[[n]][m]]][3])                    if (l2r == FALSE)                 	{arrows(pP$xx[n], -uSR$dates[[n]][m], pP$xx[n], -uSR$dates[[n]][m + 1], col = clrI,                		lwd = lwdI,   lty = ltyI, length = (uSR$types[[n]][m]==4)*barLen, code=3, angle=90)}                if (l2r == TRUE)                 	{arrows(-uSR$dates[[n]][m], pP$xx[n], -uSR$dates[[n]][m + 1], pP$xx[n], col = clrI,                		lwd = lwdI, lty = ltyI, length = (uSR$types[[n]][m]==4)*barLen, code=3, angle=90)}          }        }        par(srt = 90 * (l2r == FALSE))        x0s <- y0s <- x1s <- cls <- hlts <- hlds <- c()        prnts <- as.character(unique(pP$pn[is.na(pP$pn) == FALSE]))        for (i in 1:length(prnts)) {            offsprng <- which(pP$pn == prnts[i])            for (j in 1:length(offsprng)) {                x0s <- c(x0s, pP$xx[which(pP$nm == prnts[i])])                x1s <- c(x1s, pP$xx[offsprng[j]])                y0s <- c(y0s, pP$st[offsprng[j]])                hclO <- uSR$styles[[uSR$types[[which(pP$nm==prnts[i])]]]][2]                cls <- c(cls, hclO)                hltO <- uSR$styles[[uSR$types[[which(pP$nm==prnts[i])]]]][3]                hlts <- c(hlts, hltO)                hldO <- uSR$styles[[uSR$types[[which(pP$nm==prnts[i])]]]][1]                hlds <- c(hlds, hldO)            }        }                	        clCd <- sapply(1:length(pP$nm), function(i) uSR$styles[[min(uSR$types[[i]])]][2])        if (!is.null(hlty)) hlts <- rep(hlty,length(pP$nm))                if (l2r == FALSE) {            segments(x0s, -y0s, x1s, -y0s, col = cls, lwd = as.numeric(hlds), lty = as.numeric(hlts))            text(x = pP$xx, y = -pP$en, pP$label, adj = 0, font = 3, cex = cexLab, col=clCd)        }        if (l2r == TRUE) {            segments(-y0s, x0s, -y0s, x1s, col = cls, lwd = as.numeric(hlds), lty = as.numeric(hlts))            text(x = -pP$en, y = pP$xx, pP$label, adj = 0, font = 3, cex = cexLab, col=clCd)        }                rdPtXX <- which(sapply(1:length(uSR$dates), function(i) which(diff(uSR$dates[[i]])==0))>0)	rdPt <- unlist(sapply(1:length(uSR$dates), function(j) uSR$dates[[j]][which(diff(uSR$dates[[j]])==0)]))	if(l2r==FALSE) {arrows(pP$xx[rdPtXX],-rdPt,pP$xx[rdPtXX],-rdPt,length=0,lwd=uSR$styles$point[1])}			if(l2r==TRUE) {arrows(-rdPt,pP$xx[rdPtXX],-rdPt,pP$xx[rdPtXX],length=0,lwd=uSR$styles$point[1])}	        if (addTimeLine == "classic" | addTimeLine == "c") {            close.screen(all = TRUE)        }    }}